## Adding a Serverless Commenting System to My Blog
#### Sat 01/12/19

---

Serverless web technologies are awesome. No longer do we need to pay for servers to spin 24/hours a day to listen for a request
that may never come. Instead we can pay per request, and with a little JavaScript, make the users computer do the bulk of the work! Excellent.

My goal for this post is explain how I implemented a serverless commenting system with AWS. As I was doing this, there were two sides of the
user experience to think about: the blog readers, who will be reading and submitting comments, and myself, who will be creating the posts. From
the users point of view, the requirements are simple:

* an input for their name
* a text area for the comment body
* a button to submit
* an area to show previously submitted comments, newest first

To accomplish this I added a footer to every blog post:

#### footer.html

    <div class="footer">
      <h3>Comments</h3>
      <form>
        <input id="name" placeholder="your name" maxlength=16 required>
        <textarea id="comment-body" placeholder="your comment" required></textarea>
        <button id="save-post" type="button" onclick="saveComment()"> Submit </button>
      </form>
      <div id="comments">
        There's nothing here yet. Be the first!
      </div>
    </div>

With the footer written, next I had to think about my user perspective as the post publisher. The first problem I had was how I am going to include this into every post that I write. Furthermore, how will that
post know which number it is so that it can save comments which are associated with itself? If I were using a web server like php it would be trivial: `$post_number = 1; <?php include 'partial/footer.php'; ?>`.
It was crucial that my workflow for publishing a post be no different than it has been:

1. write the post in a markdown file `$ vim 6.md`
2. run <a href="https://github.com/knoebber/personal-website/blob/master/scripts/create-post">create-post 6</a> to create a html file and update the blog.html table
3. run <a href="https://github.com/knoebber/personal-website/blob/master/scripts/upload-site">upload-site</a> to upload the new html file to my S3 bucket.
4. and voila! this post is available on the web

After submitting a script will send out an asynchronous request to AWS, and will receive a comment object in return which will be inserted into the  and the page will be updated to show the new comment, which will consist of a date, name, and body.

The back-end will handle everything in-between the user hitting submit and the page updating. I'll use the following AWS technologies for this:

* Lambda
* API Gateway
* DynamoDB

One problem with this approach is that there can't be any preprocessing on page load. If I were using the classic LAMP stack, I might do something
like this to fetch and display all the comments:

    <div id="comments">
      <?php
        $result = $mysqli->query("SELECT `date`, `name`,`body` FROM comments WHERE post_number=$post_number ORDER BY date");
        while($comment = $result->fetch_object())
          echo make_comment($comment);
      ?>
    </div>

The advantage with this approach is that all the work is done on the server before the page is loaded. To achieve the same thing with a serverless setup , I'll have to rely on a script
to retrieve and insert the comments into the DOM *after* the page has loaded. This two obvious disadvantages:

* Users with scripts turned off will not be able to see comments
* The user may have to wait to see the comments if the connection is slow.

The advantage is that no longer will I have to pay for a server to wait nonstop for that request to run the above PHP code, instead I'll only have to pay for the individual requests that occur, and the
users web browsers can do the rest of the work. Great!

I will start this project with the front end and work my way back from there. The most obvious place to start is the actual form element that will let users submit comments. I'll make
this with JavaScript , as it won't work without it.


