## Generating and Uploading Images to S3 with Golang/Lambda
#### XXX XX/XX/19

---

I have always loved writing programs that generate interesting pictures. Something about the
experience of being surprised at the output of one my programs will always give me a warm tingly
feeling. One way to achieve interesting pictures is to recursively draw lines according to some
rules. Previously my website had an app called trees. It let the user create images of trees by
specifying different parameters:

* depth: how many times to recursively draws more branches
* branches: 2 for a binary tree, 3 for a ternary tree, etc
* length: how long in pixels each branch should be
* angle: the angle that a new branch is drawn from its parent

Here's an example of a [result](../tree_d-4_b-5_l-200_a-25.png) and here's the [source](https://github.com/knoebber/personal-website/tree/e78e112376580580bbf8d36bf02cd71ccdcc9feb/trees).
This worked by using php to call a python program that used pygame to generate the image.
Sadly, when I moved my website over to be [statically hosted](5.html), I did not reimplement it,
and it died.

### The Resurrection

Armed with my new knowledge from [making an api for a static page with lambda](6.html), and writing
in Go for my current job, I jumped into making a new and improved image generator. The first step
was to create a Go program that could generate and save an image. I decided to use the [Go Graphics](https://github.com/fogleman/gg)
library.

#### Drawing and saving a simple image in go

    :::go
    package main

    import "github.com/fogleman/gg"

    func main() {
        // gg - Go Graphics.
        c := gg.NewContext(1000, 1000)
        c.DrawCircle(400, 400, 400)
        c.SetRGB(0, 0, 0)
        c.Fill()
        c.SavePNG("circle.png")
    }

So I could save an image of a circle to my local file system. Great. The immediate problem I saw
was that I wouldn't be able to use the `SavePNG` method in lambda, as it has no filesystem. Instead,
it would have to send the image to the S3 bucket that my website is hosted on. To solve this, I
started looking through the godocs for `gg` and `aws-sdk-go`. All I needed to do was find the type
that an S3 bucket expected to receive as the body of its upload, and then find how to convert an
image from the `go graphics` library into this type. This is where go shines over the other options
for Lambda  handlers which are untyped languages -  nodejs and python. I could solve my problem
by looking at types and know that if it compiled it would work. Debugging by reading compiler
errors is a great time saver over waiting for runtime failure.

I found that I would need to use the `"github.com/aws/aws-sdk-go/service/s3"` package to call
`putObject`. This method takes a `*PutObjectInput` as its only parameter. This struct lets you
specify all sorts of (things)[https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#PutObjectInput],
but has a few required attributes:

* Bucket - the name of the S3 bucket
* Body - the data to be uploaded
* Key - the name for the data in the bucket (the key of the page you are looking at is "7.html")

So I would have set `Body` in that struct to the image that I generated. It's type is a
`io.ReadSeeker`. Next I looked in the `go graphics` library for some methods that might
return a type that matched up to this. I found the `EncodePNG` method that can be called on the
context. It has an `io.Writer` type as its parameter. It's important to note here that the 
`io` types cannot be instantiated, instead they are interfaces that
other structs can implement through duck typing. If you are familiar with Java, then an `abstract`
class is similar. The actual structs that I would use are from golang `"bytes"` package - which
implements the `io` reading and writing functionality. So I would write the bytes
from the image in the `gg`  context, and then read them into the S3 object input. Here's a working
example of creating an image with `gg` and then uploading it to a bucket:

    :::go
    package main

    import (
      "bytes"
      "fmt"
      "github.com/aws/aws-sdk-go/aws"
      "github.com/aws/aws-sdk-go/service/s3"
      "github.com/aws/aws-sdk-go/aws/session"
      "github.com/fogleman/gg"
    )

    func draw() (buffer *bytes.Buffer, err error) {
      c := gg.NewContext(1000, 1000)
      // Create the image.
      c.SetRGB(200,200, 0)
      c.DrawCircle(400, 400, 400)
      c.Fill()
      // Write the bytes from the image in the context to a buffer.
      buffer = new(bytes.Buffer)
      if err = c.EncodePNG(buffer); err != nil {
        fmt.Printf("failed to encode png %s",err.Error())
      }
      return
    }

    func main() {
      buffer, _ := draw()
      // Create a S3 client
      session := session.Must(session.NewSession(&aws.Config{
        Region: aws.String("us-west-2"),
      }))
      svc := s3.New(session)
      reader := bytes.NewReader(buffer.Bytes())
      putInput := s3.PutObjectInput{
        Bucket: aws.String("nicolasknoebber.com"),
        Body:   reader,
        Key:    aws.String("test_upload.png"),
      }
      _, err := svc.PutObject(&putInput)
      if err != nil {
        fmt.Println(err.Error())
        return
      }
    }

Key comes through local aws config.
